<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="W3" pageWidth="842" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="814" leftMargin="14" rightMargin="14" topMargin="20" bottomMargin="20">
	<parameter name="PBINTYPE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("h")]]></defaultValueExpression>
	</parameter>
	<parameter name="PVERSION" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["0.9 (2010 jan 28th, Beta)"]]></defaultValueExpression>
	</parameter>
	<parameter name="PWAFERZPARAMETER_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("facility_id")]]></defaultValueExpression>
	</parameter>
	<parameter name="PMAXNOB_IC" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new Integer(10)]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTERSERIES_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {"%"}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PFROMDATE_IC" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date(new Date().getYear()-2, 0, 1)]]></defaultValueExpression>
	</parameter>
	<parameter name="PTODATE_IC" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["day"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1VALUE_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {""}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2VALUE_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3VALUE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["%"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFAILEDBINONLY_IC" class="java.lang.Boolean">
		<defaultValueExpression><![CDATA[new Boolean(true)]]></defaultValueExpression>
	</parameter>
	<parameter name="PBINTOXCLUDE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA[""]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[select
 bin_no, bin_cat, bin_name, bin_parts, T1.zparameter, total_parts, (bin_parts/total_parts)*100 as bin_yield
from
(
  select * from
  ( SELECT
    TWB.$P!{PBINTYPE_IC}bin_no as bin_no, TWB.$P!{PBINTYPE_IC}bin_cat as bin_cat,
    case (TWB.$P!{PBINTYPE_IC}bin_name) when '' then concat('bin',TWB.$P!{PBINTYPE_IC}bin_no)
						else concat(TWB.$P!{PBINTYPE_IC}bin_name, ' (',TWB.$P!{PBINTYPE_IC}bin_no,')') end as bin_name,
    SUM(TWB.nb_parts) AS bin_parts,
    case('$P!{PWAFERZPARAMETER_IC}') when 'disabled' then TCW.disabled else TCW.$P!{PWAFERZPARAMETER_IC} end as zparameter,
    case('$P!{PFILTER1_IC}') when 'disabled' then TCW.disabled else TCW.$P!{PFILTER1_IC} end  as filter1
   from
    wt_consolidated_wafer TCW
   LEFT OUTER JOIN
    wt_wafer_$P!{PBINTYPE_IC}bin TWB
   ON TWB.lot_id=TCW.lot_id AND TWB.wafer_id=TCW.wafer_id
   WHERE TWB.$P!{PBINTYPE_IC}bin_no is not null
	AND TWB.$P!{PBINTYPE_IC}bin_no not like SUBSTRING_INDEX('$P!{PBINTOXCLUDE_IC}', ' -', 1)
	AND TWB.$P!{PBINTYPE_IC}bin_cat like CASE($P{PFAILEDBINONLY_IC}) WHEN true THEN 'F' ELSE '%' END
	AND TWB.nb_parts > 0
	AND date(from_unixtime(TCW.start_t)) >= date($P{PFROMDATE_IC})
	and date(from_unixtime(TCW.start_t)) <= date($P{PTODATE_IC})
	#AND TCW.$P!{PWAFERZPARAMETER_IC} like CASE('$P!{PFILTERSERIES_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTERSERIES_IC}' END
	#AND TCW.$P!{PFILTER1_IC} like CASE('$P!{PFILTER1VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER1VALUE_IC}' END
	#AND TCW.$P!{PFILTER2_IC} like CASE('$P!{PFILTER2VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER2VALUE_IC}' END
	#AND TCW.$P!{PFILTER3_IC} like CASE('$P!{PFILTER3VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER3VALUE_IC}' END
   group by zparameter, TWB.$P!{PBINTYPE_IC}bin_no
  ) TPARTS_PER_BIN
	where CASE (TPARTS_PER_BIN.zparameter) WHEN ('disabled') THEN (true) ELSE case('$P!{PFILTERSERIES_IC}') when ('[%]') then true
		else $X{IN,TPARTS_PER_BIN.zparameter, PFILTERSERIES_IC} end
	END
	and case when ($P{PFILTER1_IC}) IS NULL THEN true
		ELSE case ($P{PFILTER1_IC}) when ('disabled') then true
			else case ('$P!{PFILTER1VALUE_IC}') when ('[%]') then true
			 	else $X{IN, TPARTS_PER_BIN.filter1, PFILTER1VALUE_IC} end end
	END

) T1

JOIN

(
  select
    T0.zparameter as zparameter, sum(bin_parts) AS total_parts, T0.filter1 as filter1
  FROM
  (
    SELECT
  	case('$P!{PWAFERZPARAMETER_IC}') when 'disabled' then TCW.disabled else TCW.$P!{PWAFERZPARAMETER_IC} end as zparameter,
   	SUM(TWB.nb_parts) AS bin_parts,
    	case('$P!{PFILTER1_IC}') when 'disabled' then TCW.disabled else TCW.$P!{PFILTER1_IC} end  as filter1
    from
     wt_consolidated_wafer TCW
    LEFT OUTER JOIN
     wt_wafer_$P!{PBINTYPE_IC}bin TWB
    ON TWB.lot_id=TCW.lot_id AND TWB.wafer_id=TCW.wafer_id
    WHERE
	TWB.$P!{PBINTYPE_IC}bin_no is not null AND TWB.nb_parts > 0
	AND TWB.$P!{PBINTYPE_IC}bin_no not like SUBSTRING_INDEX('$P!{PBINTOXCLUDE_IC}', ' -', 1)
	AND TWB.$P!{PBINTYPE_IC}bin_cat like CASE($P{PFAILEDBINONLY_IC}) WHEN true THEN 'F' ELSE '%' END
	AND date( from_unixtime(TCW.start_t)) >= date($P{PFROMDATE_IC})
	and date(from_unixtime(TCW.start_t)) <= date($P{PTODATE_IC})
	#AND TCW.$P!{PWAFERZPARAMETER_IC} like CASE('$P!{PFILTERSERIES_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTERSERIES_IC}' END
	#AND TCW.$P!{PFILTER1_IC} like CASE('$P!{PFILTER1VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER1VALUE_IC}' END
	#AND TCW.$P!{PFILTER2_IC} like CASE('$P!{PFILTER2VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER2VALUE_IC}' END
	#AND TCW.$P!{PFILTER3_IC} like CASE('$P!{PFILTER3VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER3VALUE_IC}' END
    group by  zparameter # TWB.$P!{PBINTYPE_IC}bin_no
  ) T0
  where CASE (T0.zparameter) WHEN ('disabled') THEN (true) ELSE case('$P!{PFILTERSERIES_IC}') when ('[%]') then true
		else $X{IN,T0.zparameter, PFILTERSERIES_IC} end
	END
	and case when ($P{PFILTER1_IC}) IS NULL THEN true ELSE case ($P{PFILTER1_IC}) when ('disabled') then true
		else case ('$P!{PFILTER1VALUE_IC}') when ('[%]') then true else $X{IN, T0.filter1, PFILTER1VALUE_IC} end end
	END
  group by  zparameter
) T2
ON T1.zparameter=T2.zparameter
order by bin_parts desc
;]]>
	</queryString>
	<field name="bin_no" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_cat" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_parts" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="zparameter" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_parts" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<background>
		<band/>
	</background>
	<title>
		<band height="417">
			<textField>
				<reportElement x="0" y="0" width="814" height="29"/>
				<textElement textAlignment="Center">
					<font size="18" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[new String($P{PBINTYPE_IC}.matches("h") ? "Hard" : "Soft") + " Binning Pareto "]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="0" y="87" width="814" height="16"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="SansSerif" size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[($P{PFAILEDBINONLY_IC}.booleanValue()?"Failed bin only":"All bins")+" - Chart limited to " + $P{PMAXNOB_IC}+" records"]]></textFieldExpression>
			</textField>
			<multiAxisChart>
				<chart evaluationTime="Report">
					<reportElement x="66" y="122" width="687" height="283"/>
					<chartTitle/>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<multiAxisPlot>
					<plot/>
					<axis>
						<barChart>
							<chart evaluationTime="Report">
								<reportElement x="0" y="0" width="0" height="0" backcolor="#FFFFFF"/>
								<chartTitle color="#000000"/>
								<chartSubtitle color="#000000"/>
								<chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
							</chart>
							<categoryDataset>
								<dataset>
									<incrementWhenExpression><![CDATA[new Boolean($V{REPORT_COUNT}.intValue() <= $P{PMAXNOB_IC}.intValue())]]></incrementWhenExpression>
								</dataset>
								<categorySeries>
									<seriesExpression><![CDATA[$P{PWAFERZPARAMETER_IC}.matches( "disabled" )?"Vol":$F{zparameter}+"-Vol."]]></seriesExpression>
									<categoryExpression><![CDATA[$F{bin_name}]]></categoryExpression>
									<valueExpression><![CDATA[$F{bin_parts}]]></valueExpression>
								</categorySeries>
							</categoryDataset>
							<barPlot>
								<plot labelRotation="45.0"/>
								<itemLabel color="#000000" backgroundColor="#FFFFFF"/>
								<categoryAxisFormat labelRotation="45.0">
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</categoryAxisFormat>
								<valueAxisLabelExpression><![CDATA["Vol"]]></valueAxisLabelExpression>
								<valueAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</valueAxisFormat>
							</barPlot>
						</barChart>
					</axis>
					<axis>
						<lineChart>
							<chart evaluationTime="Report">
								<reportElement x="0" y="0" width="0" height="0" backcolor="#FFFFFF"/>
								<chartTitle color="#000000"/>
								<chartSubtitle color="#000000"/>
								<chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
							</chart>
							<categoryDataset>
								<dataset>
									<incrementWhenExpression><![CDATA[new Boolean($V{REPORT_COUNT}.intValue() <= $P{PMAXNOB_IC}.intValue())]]></incrementWhenExpression>
								</dataset>
								<categorySeries>
									<seriesExpression><![CDATA[$P{PWAFERZPARAMETER_IC}.matches( "disabled" )?"Yield":$F{zparameter}+"-Yield"]]></seriesExpression>
									<categoryExpression><![CDATA[$F{bin_name}]]></categoryExpression>
									<valueExpression><![CDATA[$F{bin_yield}]]></valueExpression>
								</categorySeries>
							</categoryDataset>
							<linePlot>
								<plot/>
								<categoryAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</categoryAxisFormat>
								<valueAxisLabelExpression><![CDATA["Yield"]]></valueAxisLabelExpression>
								<valueAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</valueAxisFormat>
							</linePlot>
						</lineChart>
					</axis>
				</multiAxisPlot>
			</multiAxisChart>
			<textField>
				<reportElement x="0" y="103" width="814" height="16">
					<printWhenExpression><![CDATA[new Boolean($P{PBINTOXCLUDE_IC}!=null)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="SansSerif" size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[(($P{PBINTOXCLUDE_IC}.matches(""))?(" "):("Bin "+$P{PBINTOXCLUDE_IC}+" excluded"))]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="29" width="814" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches("disabled")==false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PWAFERZPARAMETER_IC} + ": "+ $P{PFILTERSERIES_IC}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="49" width="814" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[new Boolean($P{PFILTER1_IC}.matches("disabled") == false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PFILTER1_IC} + ": "+ $P{PFILTER1VALUE_IC}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band/>
	</pageHeader>
	<columnHeader>
		<band height="21">
			<textField>
				<reportElement x="540" y="0" width="84" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Yield"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="297" y="0" width="98" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Volume"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="177" y="0" width="49" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Bin No"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="0" y="0" width="147" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Bin Name"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="641" y="0" width="141" height="20" backcolor="#CCCCCC">
					<printWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches( "disabled" )?false:true)]]></printWhenExpression>
				</reportElement>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Serie"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="405" y="0" width="122" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Total Volume"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="227" y="0" width="38" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Type"]]></textFieldExpression>
			</textField>
		</band>
	</columnHeader>
	<detail>
		<band height="14">
			<textField>
				<reportElement x="0" y="0" width="177" height="13"/>
				<textElement verticalAlignment="Top"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{bin_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="296" y="0" width="97" height="13"/>
				<textElement verticalAlignment="Top"/>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{bin_parts}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="178" y="1" width="48" height="13"/>
				<textElement/>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{bin_no}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="538" y="0" width="84" height="13"/>
				<textElement verticalAlignment="Top"/>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{bin_yield}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="643" y="0" width="140" height="13">
					<printWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches( "disabled" )?false:true)]]></printWhenExpression>
				</reportElement>
				<textElement verticalAlignment="Top"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{zparameter}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="405" y="1" width="133" height="13"/>
				<textElement verticalAlignment="Top"/>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{total_parts}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="230" y="0" width="38" height="13"/>
				<textElement/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{bin_cat}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band/>
	</columnFooter>
	<pageFooter>
		<band height="19">
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="1" y="0" width="99" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[new Date()]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="101" y="0" width="252" height="19"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Version "+$P{PVERSION}]]></textFieldExpression>
			</textField>
			<image vAlign="Middle" onErrorType="Icon">
				<reportElement x="377" y="0" width="32" height="19"/>
				<imageExpression class="java.lang.String"><![CDATA["repo:/Resources/galaxyb.GIF"]]></imageExpression>
			</image>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="558" y="0" width="205" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Page " + $V{PAGE_NUMBER} + " of  "]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="763" y="0" width="51" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="66">
			<textField>
				<reportElement x="1" y="0" width="813" height="66"/>
				<textElement verticalAlignment="Middle" markup="html"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Notes :<br> - Total parts measures have been computed using consolidated data. <br> - The Yield measure is computed from the number of parts with the specified binning compared to the total number of parts.<br>"]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
