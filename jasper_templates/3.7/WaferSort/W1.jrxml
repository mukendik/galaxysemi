<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="W1" printOrder="Horizontal" pageWidth="595" pageHeight="842" whenNoDataType="AllSectionsNoDetail" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" isTitleNewPage="true">
	<import value="java.util.*"/>
	<parameter name="PTIME_IC" class="java.lang.String">
		<parameterDescription><![CDATA[Time frequency : enter Day, Week, Month or Quarter]]></parameterDescription>
		<defaultValueExpression><![CDATA["month"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFROMDATE_IC" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date(new Date().getYear()-3, 0, 1)]]></defaultValueExpression>
	</parameter>
	<parameter name="PTODATE_IC" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="PWAFERZPARAMETER_IC" class="java.lang.String">
		<parameterDescription><![CDATA[]]></parameterDescription>
		<defaultValueExpression><![CDATA["facility_id"]]></defaultValueExpression>
	</parameter>
	<parameter name="PSHOWTABLES_IC" class="java.lang.Boolean">
		<defaultValueExpression><![CDATA[new Boolean("true")]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTERSERIES_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {"%"}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PVERSION" class="java.lang.String">
		<defaultValueExpression><![CDATA["0.9 (2010 jan 20th)"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1VALUE_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {""}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2VALUE_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3VALUE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["%"]]></defaultValueExpression>
	</parameter>
	<parameter name="PYIELDMIN_IC" class="java.lang.Float">
		<defaultValueExpression><![CDATA[new Float(0)]]></defaultValueExpression>
	</parameter>
	<parameter name="PYIELDMAX_IC" class="java.lang.Float">
		<defaultValueExpression><![CDATA[new Float(100)]]></defaultValueExpression>
	</parameter>
	<parameter name="LoggedInUsername" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[$P{LoggedInUser}.getUsername()]]></defaultValueExpression>
	</parameter>
	<parameter name="LoggedInUser" class="com.jaspersoft.jasperserver.api.metadata.user.domain.User" isForPrompting="false"/>
	<parameter name="LoggedInUserFullName " class="java.lang.String" isForPrompting="false"/>
	<parameter name="Username" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[$P{LoggedInUser}.getFullName()]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[select *
from
(
	select * from
	(
	 select
	  TCW.start_t as start_t,
	  TCW.$P!{PTIME_IC} as xparameter,
	  SUM(TCW.parts) as parts,
	  SUM(TCW.parts_good) as parts_good,
	  SUM(TCW.gross_die) as gross_die,
	  ((SUM(TCW.parts_good) / SUM(TCW.parts)) * 100.0) as yield,
	  ((SUM(TCW.parts_good) / SUM(TCW.gross_die)) * 100.0) as gross_yield,
	  TCW.$P!{PWAFERZPARAMETER_IC} as zparameter,
	  TCW.$P!{PWAFERZPARAMETER_IC} as orderparameter,
	  TCW.$P!{PFILTER1_IC} as filter1, TCW.$P!{PFILTER2_IC} as filter2
	 from
	  wt_consolidated_wafer TCW
	group by
	 xparameter, zparameter

	) TCW2
	where
  	 date( from_unixtime(TCW2.start_t)) >= $P{PFROMDATE_IC}
  	 and date( from_unixtime(TCW2.start_t)) <= $P{PTODATE_IC}
	 and CASE (TCW2.zparameter) WHEN ('disabled') THEN (true) ELSE
		case('$P!{PFILTERSERIES_IC}') when ('[%]') then true else $X{IN, TCW2.zparameter, PFILTERSERIES_IC} end END
	 and case when ($P{PFILTER1_IC}) IS NULL THEN true
		ELSE case ($P{PFILTER1_IC}) when ('disabled') then true else case ('$P!{PFILTER1VALUE_IC}') when ('[%]') then true
			 	else $X{IN, TCW2.filter1, PFILTER1VALUE_IC} end end END
	 and case when ($P{PFILTER2_IC}) IS NULL THEN true
		ELSE case ($P{PFILTER2_IC}) when ('disabled') then true else case ('$P!{PFILTER2VALUE_IC}') when ('[%]') then true
			 	else $X{IN, TCW2.filter2, PFILTER2VALUE_IC} end end END

) T

union
select *
from
(
	select * from
	(
	 select
	  TCW.start_t as start_t,
	  TCW.$P!{PTIME_IC} as xparameter,
	  SUM(TCW.parts) as parts,
	  SUM(TCW.parts_good) as parts_good,
	  SUM(TCW.gross_die) as gross_die,
	  ((SUM(TCW.parts_good) / SUM(TCW.parts)) * 100.0) as yield,
	  ((SUM(TCW.parts_good) / SUM(TCW.gross_die)) * 100.0) as gross_yield,
	  "Overall" as zparameter,
	  TCW.$P!{PFILTER1_IC} as filter1,	 TCW.$P!{PFILTER2_IC} as filter2,
	  "zzzzzzz" as orderparameter
	 from
	  wt_consolidated_wafer TCW
	 group by xparameter
	) TCW3
	where
  	 date( from_unixtime(TCW3.start_t)) >= $P{PFROMDATE_IC}
  	 and date( from_unixtime(TCW3.start_t)) <= $P{PTODATE_IC}
	 and case when ($P{PFILTER1_IC}) IS NULL THEN true
		ELSE case ($P{PFILTER1_IC}) when ('disabled') then true
			else case ('$P!{PFILTER1VALUE_IC}') when ('[%]') then true
			 	else $X{IN, TCW3.filter1, PFILTER1VALUE_IC} end end END
	 and case when ($P{PFILTER2_IC}) IS NULL THEN true
		ELSE case ($P{PFILTER2_IC}) when ('disabled') then true
			else case ('$P!{PFILTER2VALUE_IC}') when ('[%]') then true
			 	else $X{IN, TCW3.filter2, PFILTER2VALUE_IC} end end END

) TOVERALL
order by
	xparameter, gross_die, orderparameter
]]>
	</queryString>
	<field name="xparameter" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="parts" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="parts_good" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="gross_die" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="gross_yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="zparameter" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<group name="XAxis">
		<groupExpression><![CDATA[$F{xparameter}]]></groupExpression>
		<groupHeader>
			<band>
				<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="2">
				<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
				<line>
					<reportElement isPrintRepeatedValues="false" x="1" y="0" width="400" height="1" printWhenGroupChanges="XAxis"/>
				</line>
			</band>
		</groupFooter>
	</group>
	<background>
		<band/>
	</background>
	<title>
		<band height="533">
			<textField evaluationTime="Report">
				<reportElement x="0" y="0" width="556" height="26"/>
				<textElement textAlignment="Center" verticalAlignment="Top">
					<font size="18" isBold="true" isItalic="false" isUnderline="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Overall Wafer Test Yields "]]></textFieldExpression>
			</textField>
			<multiAxisChart>
				<chart isShowLegend="true" evaluationTime="Report">
					<reportElement isPrintRepeatedValues="false" x="0" y="104" width="556" height="428"/>
					<chartTitle/>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<multiAxisPlot>
					<plot/>
					<axis>
						<lineChart>
							<chart isShowLegend="true">
								<reportElement x="0" y="0" width="0" height="0" backcolor="#FFFFFF"/>
								<chartTitle color="#000000"/>
								<chartSubtitle color="#000000"/>
								<chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
							</chart>
							<categoryDataset>
								<dataset>
									<incrementWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches("disabled") == false || ($P{PWAFERZPARAMETER_IC}.matches("disabled") && ($F{zparameter}.matches("Overall"))))]]></incrementWhenExpression>
								</dataset>
								<categorySeries>
									<seriesExpression><![CDATA[$F{zparameter}+" - Yield"]]></seriesExpression>
									<categoryExpression><![CDATA[$F{xparameter}]]></categoryExpression>
									<valueExpression><![CDATA[$F{gross_yield}]]></valueExpression>
								</categorySeries>
							</categoryDataset>
							<linePlot>
								<plot labelRotation="-45.0">
									<seriesColor seriesOrder="0" color="#BA2525"/>
									<seriesColor seriesOrder="1" color="#9191F7"/>
									<seriesColor seriesOrder="2" color="#C4C426"/>
									<seriesColor seriesOrder="3" color="#026323"/>
									<seriesColor seriesOrder="4" color="#A668A6"/>
									<seriesColor seriesOrder="5" color="#467474"/>
									<seriesColor seriesOrder="6" color="#A74504"/>
									<seriesColor seriesOrder="7" color="#3D7E3D"/>
									<seriesColor seriesOrder="8" color="#421C42"/>
									<seriesColor seriesOrder="9" color="#3B3B81"/>
									<seriesColor seriesOrder="10" color="#00386C"/>
									<seriesColor seriesOrder="11" color="#3E3E27"/>
								</plot>
								<categoryAxisLabelExpression><![CDATA[$P{PTIME_IC}]]></categoryAxisLabelExpression>
								<categoryAxisFormat labelRotation="-45.0">
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</categoryAxisFormat>
								<valueAxisLabelExpression><![CDATA["Yield (%)"]]></valueAxisLabelExpression>
								<valueAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</valueAxisFormat>
								<rangeAxisMinValueExpression><![CDATA[$P{PYIELDMIN_IC}]]></rangeAxisMinValueExpression>
								<rangeAxisMaxValueExpression><![CDATA[$P{PYIELDMAX_IC}]]></rangeAxisMaxValueExpression>
							</linePlot>
						</lineChart>
					</axis>
					<axis>
						<barChart>
							<chart isShowLegend="true">
								<reportElement x="0" y="0" width="0" height="0" backcolor="#FFFFFF"/>
								<chartTitle color="#000000"/>
								<chartSubtitle color="#000000"/>
								<chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
							</chart>
							<categoryDataset>
								<dataset>
									<incrementWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches("disabled") == false || ($P{PWAFERZPARAMETER_IC}.matches("disabled") && ($F{zparameter}.matches("Overall"))))]]></incrementWhenExpression>
								</dataset>
								<categorySeries>
									<seriesExpression><![CDATA[$F{zparameter}+ " - Vol."]]></seriesExpression>
									<categoryExpression><![CDATA[$F{xparameter}]]></categoryExpression>
									<valueExpression><![CDATA[$F{gross_die}]]></valueExpression>
								</categorySeries>
							</categoryDataset>
							<barPlot>
								<plot labelRotation="45.0">
									<seriesColor seriesOrder="0" color="#FF3333"/>
									<seriesColor seriesOrder="1" color="#3333FF"/>
									<seriesColor seriesOrder="2" color="#FFFF00"/>
									<seriesColor seriesOrder="3" color="#009933"/>
									<seriesColor seriesOrder="4" color="#FF99FF"/>
									<seriesColor seriesOrder="5" color="#99FFFF"/>
									<seriesColor seriesOrder="6" color="#FF6600"/>
									<seriesColor seriesOrder="7" color="#66FF66"/>
									<seriesColor seriesOrder="8" color="#990099"/>
									<seriesColor seriesOrder="9" color="#9999FF"/>
									<seriesColor seriesOrder="10" color="#2B88DE"/>
									<seriesColor seriesOrder="11" color="#666600"/>
								</plot>
								<itemLabel color="#000000" backgroundColor="#FFFFFF"/>
								<categoryAxisFormat labelRotation="45.0">
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</categoryAxisFormat>
								<valueAxisLabelExpression><![CDATA["Volume"]]></valueAxisLabelExpression>
								<valueAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</valueAxisFormat>
							</barPlot>
						</barChart>
					</axis>
				</multiAxisPlot>
			</multiAxisChart>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="26" width="556" height="20">
					<printWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches("disabled")==false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PWAFERZPARAMETER_IC} + ": "+ $P{PFILTERSERIES_IC}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="46" width="556" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[new Boolean($P{PFILTER1_IC}.matches("disabled") == false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PFILTER1_IC} + ": "+ $P{PFILTER1VALUE_IC}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="66" width="556" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[new Boolean($P{PFILTER2_IC}.matches("disabled") == false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PFILTER2_IC} + ": "+ $P{PFILTER2VALUE_IC}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band height="29">
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="20">
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
			<textField>
				<reportElement x="1" y="0" width="99" height="20" backcolor="#CCCCCC"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PTIME_IC}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="201" y="0" width="100" height="20" backcolor="#CCCCCC"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Volume"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="301" y="0" width="100" height="20" backcolor="#CCCCCC"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Yield"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="100" y="0" width="101" height="20" backcolor="#CCCCCC"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[new String($P{PWAFERZPARAMETER_IC}.matches( "disabled" ) ? "" : $P{PWAFERZPARAMETER_IC})]]></textFieldExpression>
			</textField>
		</band>
	</columnHeader>
	<detail>
		<band height="23">
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue() && ($P{PWAFERZPARAMETER_IC}.matches("disabled") == false || ($P{PWAFERZPARAMETER_IC}.matches("disabled") && ($F{zparameter}.matches("Overall")))))]]></printWhenExpression>
			<textField>
				<reportElement isPrintRepeatedValues="false" x="0" y="3" width="100" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{xparameter}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="201" y="3" width="100" height="20"/>
				<textElement textAlignment="Right" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{gross_die}.toString()]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="100" y="3" width="101" height="20"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[new String($P{PWAFERZPARAMETER_IC}.matches( "disabled" ) ? "" : $F{zparameter})]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="301" y="3" width="100" height="20"/>
				<textElement textAlignment="Right" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{gross_yield}.setScale(2,BigDecimal.ROUND_DOWN).toString()+" %"]]></textFieldExpression>
			</textField>
			<line>
				<reportElement x="100" y="0" width="301" height="1"/>
			</line>
			<line>
				<reportElement isPrintRepeatedValues="false" x="1" y="0" width="400" height="1" printWhenGroupChanges="XAxis"/>
			</line>
		</band>
	</detail>
	<columnFooter>
		<band>
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
		</band>
	</columnFooter>
	<pageFooter>
		<band height="19">
			<textField>
				<reportElement x="89" y="0" width="163" height="19"/>
				<textElement textAlignment="Left" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Version "+$P{PVERSION}]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="1" y="0" width="88" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[new Date()]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="310" y="0" width="206" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Page " + $V{PAGE_NUMBER} + " of "]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="516" y="0" width="39" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<image hAlign="Center" vAlign="Middle" onErrorType="Icon">
				<reportElement x="252" y="0" width="58" height="19"/>
				<imageExpression class="java.lang.String"><![CDATA["repo:/Resources/galaxyb.GIF"]]></imageExpression>
			</image>
		</band>
	</pageFooter>
	<summary>
		<band height="89">
			<textField evaluationTime="Report">
				<reportElement x="1" y="0" width="554" height="89"/>
				<textElement verticalAlignment="Middle" markup="html"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Notes :<br> - Total parts measures have been computed using consolidated data. <br> - The Yield measure is computed from the total number of good parts and the total gross die.<br>"+"<br>Report generated by jasper user '"+$P{LoggedInUser}.getUsername()+"'"]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
