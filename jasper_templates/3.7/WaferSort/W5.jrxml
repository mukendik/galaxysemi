<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="W5" columnCount="15" printOrder="Horizontal" pageWidth="842" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="54" leftMargin="13" rightMargin="13" topMargin="20" bottomMargin="20" whenResourceMissingType="Empty">
	<style name="Crosstab Data Text" isDefault="false"/>
	<parameter name="PWAFERZPARAMETER_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["product_id"]]></defaultValueExpression>
	</parameter>
	<parameter name="PYEARS_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["2008"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTERSERIES_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {"%"}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["tester_name"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1VALUE_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {""}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PVERSION" class="java.lang.String">
		<defaultValueExpression><![CDATA["0.3 (2010 Jan 29th Beta)"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2VALUE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["%"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3VALUE_IC" class="java.lang.String"/>
	<queryString>
		<![CDATA[select
 W5.product_id as product_id,
 W5.fab,
 W5.serie as serie, W5.filter1,
 W5.month,
 W5.parts_gross_die as parts_gross_die,
 W5.parts_good as parts_good,
 W5.good_yield as good_yield,
 GDPWT.GDPW as GDPW
from
(
  select
   MONTHS.product_id as product_id,
   MONTHS.fab,
   MONTHS.serie as serie,
   MONTHS.filter1,
   MONTHS.month,
   case when PARTS.tot_gross_die is null then 0 else PARTS.tot_gross_die end as parts_gross_die,
   case when PARTS.tot_good is null then 0 else PARTS.tot_good end as parts_good,
   case when PARTS.tot_gross_die is null then 0 else (PARTS.tot_good / PARTS.tot_gross_die) * 100 end as good_yield
  from
  (
	select * from
	(
	 select
      	  TCW.product_id as product_id,
      	  TCW.facility_id as fab,      TCW.month as month,
      	  case($P{PWAFERZPARAMETER_IC}) WHEN 'Disabled' then TCW.disabled else TCW.$P!{PWAFERZPARAMETER_IC} end as serie,
 	  case($P{PFILTER1_IC}) WHEN 'Disabled' then TCW.disabled else TCW.$P!{PFILTER1_IC} end as filter1,
      	  SUM(TCW.gross_die) as tot_gross_die,      SUM(TCW.parts_good) as tot_good
    	 from
      	  wt_consolidated_wafer TCW
    	 where
      	  TCW.year=$P{PYEARS_IC}
	) TCW2
	where CASE (TCW2.filter1) WHEN ('disabled') THEN (true)
	 ELSE case('$P!{PFILTER1VALUE_IC}') when ('[%]') then true else $X{IN,TCW2.filter1, PFILTER1VALUE_IC} end END

	#AND TCW.$P!{PWAFERZPARAMETER_IC} like CASE('$P!{PFILTERSERIES_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTERSERIES_IC}' END
	#AND TCW.$P!{PFILTER1_IC} like CASE('$P!{PFILTER1VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER1VALUE_IC}' END
    	group by product_id, fab, serie, month
  ) PARTS
  right outer join
  (
    select
      T0.product_id,
      T0.fab,
      T0.serie, T0.filter1,
      T1.month
    from
    (
	select * from
      	(
	 select distinct
          TCW.product_id as product_id,
          TCW.facility_id as fab,
          case($P{PWAFERZPARAMETER_IC}) WHEN 'Disabled' then TCW.disabled else TCW.$P!{PWAFERZPARAMETER_IC} end as serie,
          case($P{PFILTER1_IC}) WHEN 'Disabled' then TCW.disabled else TCW.$P!{PFILTER1_IC} end as filter1
      	 from
          wt_consolidated_wafer TCW
      	 where
	  TCW.year=$P{PYEARS_IC}
	) TCW3
	where CASE (TCW3.filter1) WHEN ('disabled') THEN (true)
	 ELSE case('$P!{PFILTER1VALUE_IC}') when ('[%]') then true else $X{IN,TCW3.filter1, PFILTER1VALUE_IC} end END

	#AND TCW.$P!{PWAFERZPARAMETER_IC} like CASE('$P!{PFILTERSERIES_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTERSERIES_IC}' END
	#AND TCW.$P!{PFILTER1_IC} like CASE('$P!{PFILTER1VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER1VALUE_IC}' END
    ) T0
    inner join
    (
        select CONVERT(concat($P{PYEARS_IC},'-01'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-02'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-03'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-04'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-05'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-06'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-07'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-08'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-09'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-10'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-11'), CHAR) as month
        UNION select CONVERT(concat($P{PYEARS_IC},'-12'), CHAR) as month
    ) T1
  ) MONTHS
  on
   MONTHS.product_id=PARTS.product_id AND
   MONTHS.fab=PARTS.fab AND
   MONTHS.serie=PARTS.serie AND
   MONTHS.month=PARTS.month
  where	CASE (MONTHS.serie) WHEN ('disabled') THEN (true)
	ELSE case('$P!{PFILTERSERIES_IC}') when ('[%]') then true else $X{IN,MONTHS.serie, PFILTERSERIES_IC} end END

  UNION

  select
    YTD.product_id as product_id,
    YTD.fab,
    YTD.serie as serie, YTD.filter1,
    YTD.month,
    YTD.tot_gross_die as parts_gross_die,
    YTD.tot_good as parts_good,
    (YTD.tot_good / YTD.tot_gross_die) * 100 as good_yield
  from
  (
    select * from
    (
	select
      	 TCW.product_id as product_id,
      	 TCW.facility_id as fab,
      	 case($P{PWAFERZPARAMETER_IC}) WHEN 'Disabled' then TCW.disabled else TCW.$P!{PWAFERZPARAMETER_IC} end as serie,
      	 case($P{PFILTER1_IC}) WHEN 'Disabled' then TCW.disabled else TCW.$P!{PFILTER1_IC} end as filter1,
      	 'YTD' as month,
      	 SUM(TCW.gross_die) as tot_gross_die,
      	 SUM(TCW.parts_good) as tot_good
    	from
      	 wt_consolidated_wafer TCW
    	where
	 TCW.year=$P{PYEARS_IC}
    ) TCW4
	where	CASE (TCW4.serie) WHEN ('disabled') THEN (true)
	 ELSE case('$P!{PFILTERSERIES_IC}') when ('[%]') then true else $X{IN, TCW4.serie, PFILTERSERIES_IC} end
	 END
	and where CASE (TCW4.filter1) WHEN ('disabled') THEN (true)
	 ELSE case('$P!{PFILTER1VALUE_IC}') when ('[%]') then true else $X{IN,TCW4.filter1, PFILTER1VALUE_IC} end END

	#AND TCW.$P!{PWAFERZPARAMETER_IC} like CASE('$P!{PFILTERSERIES_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTERSERIES_IC}' END
	#AND TCW.$P!{PFILTER1_IC} like CASE('$P!{PFILTER1VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER1VALUE_IC}' END
    group by TCW4.product_id, TCW4.fab, TCW4.serie

  ) YTD

) W5
inner join
(
	select T.product_id, TCW2.gross_die as GDPW
	from
	(
	 select product_id as product_id, max(start_t) as max_start_t
	 from wt_consolidated_wafer TCW1
	 group by product_id
	) T
	inner join
	 wt_consolidated_wafer TCW2
	on TCW2.product_id=T.product_id AND TCW2.start_t=T.max_start_t
	group by T.product_id
) GDPWT
on W5.product_id=GDPWT.product_id

order by W5.product_id, W5.fab, W5.serie, W5.month;]]>
	</queryString>
	<field name="product_id" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="fab" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="serie" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="month" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="parts_gross_die" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="parts_good" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="good_yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="GDPW" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="filter1" class="java.lang.String"/>
	<group name="pft">
		<groupExpression><![CDATA[$F{product_id}+"-"+$F{fab}+"-"+$F{serie}]]></groupExpression>
		<groupHeader>
			<band height="15" splitType="Prevent">
				<line>
					<reportElement x="1" y="0" width="813" height="1"/>
				</line>
				<textField>
					<reportElement x="1" y="1" width="815" height="14"/>
					<textElement verticalAlignment="Middle">
						<font size="10" isBold="true"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA["Product "+$F{product_id}
+" - Fab "
+(($F{fab}==null)?"?":$F{fab})
+ " GDPW="+$F{GDPW}.toString()+" "
+ ( ($P{PWAFERZPARAMETER_IC}.matches(new String("disabled")) || ($P{PWAFERZPARAMETER_IC}==null))?(" "):(" - "+$P{PWAFERZPARAMETER_IC}+":"+(($F{serie}==null)?"":$F{serie})) )
+ " "+$F{filter1}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band splitType="Prevent"/>
		</groupFooter>
	</group>
	<background>
		<band/>
	</background>
	<title>
		<band height="90">
			<textField>
				<reportElement x="0" y="0" width="816" height="23"/>
				<textElement textAlignment="Center">
					<font size="14" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PYEARS_IC}+" Products details "]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="23" width="816" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[new Boolean($P{PWAFERZPARAMETER_IC}.matches("disabled")==false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PWAFERZPARAMETER_IC} + ": "+ $P{PFILTERSERIES_IC}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="0" y="43" width="816" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[new Boolean($P{PFILTER1_IC}.matches("disabled") == false)]]></printWhenExpression>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[$P{PFILTER1_IC} + ": "+ $P{PFILTER1VALUE_IC}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band/>
	</pageHeader>
	<columnHeader>
		<band/>
	</columnHeader>
	<detail>
		<band height="47" splitType="Prevent">
			<textField>
				<reportElement x="55" y="1" width="52" height="11" isPrintInFirstWholeBand="true" printWhenGroupChanges="pft"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{month}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement isPrintRepeatedValues="false" x="9" y="1" width="44" height="11" isPrintInFirstWholeBand="true" printWhenGroupChanges="pft"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Month"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="55" y="12" width="52" height="11" isPrintInFirstWholeBand="true"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{parts_gross_die}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement isPrintRepeatedValues="false" x="9" y="12" width="44" height="11" isPrintInFirstWholeBand="true" printWhenGroupChanges="pft"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["IN"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement isPrintRepeatedValues="false" x="9" y="23" width="44" height="11" printWhenGroupChanges="pft"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["OUT"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="55" y="23" width="52" height="11" isPrintInFirstWholeBand="true"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.math.BigDecimal"><![CDATA[$F{parts_good}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement isPrintRepeatedValues="false" x="9" y="34" width="44" height="11" printWhenGroupChanges="pft"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Yield"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="55" y="34" width="52" height="11" isPrintInFirstWholeBand="true"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{good_yield}.setScale(2,BigDecimal.ROUND_DOWN).toString()+"%"]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band/>
	</columnFooter>
	<pageFooter>
		<band height="19">
			<textField evaluationTime="Report" pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="761" y="0" width="55" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Bottom">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="581" y="0" width="178" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Bottom">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Page " + $V{PAGE_NUMBER} + " of "]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="0" y="0" width="211" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Bottom">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[new Date()]]></textFieldExpression>
			</textField>
			<image vAlign="Middle" onErrorType="Icon">
				<reportElement x="401" y="0" width="53" height="19"/>
				<imageExpression class="java.lang.String"><![CDATA["repo:/Resources/galaxyb.GIF"]]></imageExpression>
			</image>
			<textField>
				<reportElement x="211" y="0" width="184" height="19"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Version "+$P{PVERSION}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="40">
			<textField>
				<reportElement x="1" y="0" width="815" height="40"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA[" Notes : - Total parts measures have been computed using consolidated data. - The Yield measure is computed from the total number of good parts and the total gross die."]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
