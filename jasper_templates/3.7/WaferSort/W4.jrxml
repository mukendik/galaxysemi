<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="W4" printOrder="Horizontal" pageWidth="842" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="816" leftMargin="13" rightMargin="13" topMargin="20" bottomMargin="20" whenResourceMissingType="Empty">
	<parameter name="PFROMDATE_IC" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date(new Date().getYear()-2, 0, 1)]]></defaultValueExpression>
	</parameter>
	<parameter name="PTODATE_IC" class="java.util.Date">
		<defaultValueExpression><![CDATA[new Date()]]></defaultValueExpression>
	</parameter>
	<parameter name="PWAFERZPARAMETER_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PSHOWTABLES_IC" class="java.lang.Boolean">
		<defaultValueExpression><![CDATA[new Boolean("true")]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTERSERIES_IC" class="java.util.Collection">
		<defaultValueExpression><![CDATA[new ArrayList(Arrays.asList(new String[] {"%"}))]]></defaultValueExpression>
	</parameter>
	<parameter name="PVERSION" class="java.lang.String">
		<defaultValueExpression><![CDATA["0.5 (Jan 29th 2010, Beta)"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER1VALUE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["-"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["disabled"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER2VALUE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="PBINNUMBER_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["Worst Bin"]]></defaultValueExpression>
	</parameter>
	<parameter name="PBINTYPE_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["h"]]></defaultValueExpression>
	</parameter>
	<parameter name="PFILTER3_IC" class="java.lang.String"/>
	<parameter name="PFILTER3VALUE_IC" class="java.lang.String"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["C:\\Documents and Settings\\HerveT\\Local Settings\\Temp\\jstmp\\"]]></defaultValueExpression>
	</parameter>
	<parameter name="PPRODUCT_IC" class="java.lang.String">
		<defaultValueExpression><![CDATA["%"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[select
	T.xparameter as lot_id,
	T.gross_die as gross_die,
	T.parts as parts,
	T.bin_parts as bin_parts,
	(T.bin_parts / T.gross_die) * 100 as gross_yield,
	(T.bin_parts / T.parts) * 100 as yield,
  	tot_good,
  	(T.tot_good / T.gross_die) * 100 as overall_yield,
  	T.bin_no as bin_no, T.bin_name,
	T2.worst_bin, T2.worst_bin_name,
	SUBSTRING_INDEX('$P!{PBINNUMBER_IC}', ' -', 1) as selected_bin_no
from
(
	select TCW.lot_id as xparameter, SUM(TCW.gross_die) AS gross_die, SUM(TCW.parts) AS parts,
    		SUM(parts_good) as tot_good,
		SUM(case when THB.nb_parts is null then 0 else THB.nb_parts end) AS bin_parts,
    		BINLIST.bin_no, BINLIST.bin_name
	from
		wt_consolidated_wafer TCW
  	inner join
	(
              select
		TB.$P!{PBINTYPE_IC}bin_no as bin_no,
		case when (TB.$P!{PBINTYPE_IC}bin_name) = "" then concat("bin ", TB.$P!{PBINTYPE_IC}bin_no) else TB.$P!{PBINTYPE_IC}bin_name end as bin_name
              from wt_lot TL
              inner join
              wt_lot_$P!{PBINTYPE_IC}bin TB
              ON TB.lot_id=TL.lot_id
              where product_name=$P{PPRODUCT_IC}
              group by TB.$P!{PBINTYPE_IC}bin_no
              order by TB.$P!{PBINTYPE_IC}bin_no, TB.$P!{PBINTYPE_IC}bin_name

	) BINLIST
	left outer join wt_wafer_$P!{PBINTYPE_IC}bin THB
	on THB.lot_id=TCW.lot_id AND THB.wafer_id=TCW.wafer_id AND THB.$P!{PBINTYPE_IC}bin_no=BINLIST.bin_no

	where
		TCW.product_id = $P{PPRODUCT_IC}
		AND date( from_unixtime(TCW.start_t)) >= date($P{PFROMDATE_IC})
		AND date(from_unixtime(TCW.start_t)) <= date($P{PTODATE_IC})
		AND TCW.$P!{PFILTER1_IC} like CASE('$P!{PFILTER1VALUE_IC}') WHEN 'null' THEN '%' ELSE '$P!{PFILTER1VALUE_IC}' END

	group by xparameter, BINLIST.bin_no
) T
inner join
(
  select T1.bin_no as worst_bin,
	case (T1.bin_name) when '' then concat("bin ",T1.bin_no) else T1.bin_name end as worst_bin_name
  , MAX(T1.bin_parts)
  from
  (
   select
   THB.$P!{PBINTYPE_IC}bin_no as bin_no, THB.$P!{PBINTYPE_IC}bin_name as bin_name,
   SUM(THB.nb_parts) as bin_parts
  from
   wt_consolidated_wafer TCW
  left outer join
   wt_wafer_$P!{PBINTYPE_IC}bin THB
  on THB.lot_id=TCW.lot_id AND THB.wafer_id=TCW.wafer_id
  where TCW.product_id= $P{PPRODUCT_IC}
	AND THB.$P!{PBINTYPE_IC}bin_cat='F'  #  ANAMQ30DGOA
  group by THB.$P!{PBINTYPE_IC}bin_no
  order by bin_parts desc
  ) T1
) T2
order by xparameter, gross_yield DESC;]]>
	</queryString>
	<field name="lot_id" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="gross_die" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="parts" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_parts" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="gross_yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="tot_good" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="overall_yield" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_no" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="bin_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="worst_bin" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="worst_bin_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="selected_bin_no" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<variable name="lot_count" class="java.lang.Integer" incrementType="Group" incrementGroup="XAxis" calculation="DistinctCount">
		<variableExpression><![CDATA[$F{lot_id}]]></variableExpression>
		<initialValueExpression><![CDATA[new Integer(0)]]></initialValueExpression>
	</variable>
	<variable name="max_overall_vol" class="java.math.BigDecimal" incrementType="Group" incrementGroup="XAxis" calculation="Highest">
		<variableExpression><![CDATA[$F{parts}]]></variableExpression>
		<initialValueExpression><![CDATA[new BigDecimal(10)]]></initialValueExpression>
	</variable>
	<group name="XAxis">
		<groupExpression><![CDATA[$F{lot_id}]]></groupExpression>
		<groupHeader>
			<band height="2">
				<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
				<line>
					<reportElement isPrintRepeatedValues="false" x="1" y="0" width="554" height="1" printWhenGroupChanges="XAxis"/>
				</line>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="2">
				<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
			</band>
		</groupFooter>
	</group>
	<background>
		<band/>
	</background>
	<title>
		<band height="471">
			<textField evaluationTime="Report">
				<reportElement x="0" y="0" width="816" height="32"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="18" isBold="true" isItalic="false" isUnderline="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Product "+ $P{PPRODUCT_IC} +" Trend ("+$V{lot_count}.toString()+" lots)"]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="false">
				<reportElement x="1" y="34" width="814" height="20" isRemoveLineWhenBlank="true"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font fontName="SansSerif" size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[($P{PBINTYPE_IC}.matches("s")?"Soft bin : ":"Hard bin : ")+" "+ ($P{PBINNUMBER_IC}.matches("Worst Bin")?(" the worst : "+$F{worst_bin_name}+"(bin "+$F{worst_bin}.toString()+")"):$P{PBINNUMBER_IC})]]></textFieldExpression>
			</textField>
			<multiAxisChart>
				<chart isShowLegend="true" evaluationTime="Report">
					<reportElement isPrintRepeatedValues="false" x="0" y="70" width="815" height="383"/>
					<chartTitle/>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<multiAxisPlot>
					<plot/>
					<axis>
						<lineChart>
							<chart isShowLegend="true">
								<reportElement x="0" y="0" width="0" height="0" backcolor="#FFFFFF"/>
								<chartTitle color="#000000"/>
								<chartSubtitle color="#000000"/>
								<chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
							</chart>
							<categoryDataset>
								<dataset>
									<incrementWhenExpression><![CDATA[new Boolean(
    ($V{lot_count}.intValue()<50)
    &&
    ( $F{bin_no}.equals
      (
        $P{PBINNUMBER_IC}.equals(new String("Worst Bin"))?
         $F{worst_bin}
         :new Integer($F{selected_bin_no})
      )
    )
)]]></incrementWhenExpression>
								</dataset>
								<categorySeries>
									<seriesExpression><![CDATA[$F{selected_bin_no}.matches("Worst Bin")?"Worst Bin Yield":("Bin "+$F{selected_bin_no})
+" Yield"]]></seriesExpression>
									<categoryExpression><![CDATA[$F{lot_id}]]></categoryExpression>
									<valueExpression><![CDATA[$F{gross_yield}]]></valueExpression>
								</categorySeries>
								<categorySeries>
									<seriesExpression><![CDATA["Overall Yield"]]></seriesExpression>
									<categoryExpression><![CDATA[$F{lot_id}]]></categoryExpression>
									<valueExpression><![CDATA[$F{overall_yield}]]></valueExpression>
								</categorySeries>
							</categoryDataset>
							<linePlot>
								<plot labelRotation="45.0"/>
								<categoryAxisFormat labelRotation="45.0">
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</categoryAxisFormat>
								<valueAxisLabelExpression><![CDATA["Yield (%)"]]></valueAxisLabelExpression>
								<valueAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</valueAxisFormat>
							</linePlot>
						</lineChart>
					</axis>
					<axis>
						<barChart>
							<chart isShowLegend="true">
								<reportElement x="0" y="0" width="0" height="0" backcolor="#FFFFFF"/>
								<chartTitle color="#000000"/>
								<chartSubtitle color="#000000"/>
								<chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
							</chart>
							<categoryDataset>
								<dataset>
									<incrementWhenExpression><![CDATA[new Boolean($V{lot_count}.intValue()<50)]]></incrementWhenExpression>
								</dataset>
								<categorySeries>
									<seriesExpression><![CDATA["Overall Vol"]]></seriesExpression>
									<categoryExpression><![CDATA[$F{lot_id}]]></categoryExpression>
									<valueExpression><![CDATA[$F{parts}]]></valueExpression>
								</categorySeries>
							</categoryDataset>
							<barPlot>
								<plot labelRotation="45.0"/>
								<itemLabel color="#000000" backgroundColor="#FFFFFF"/>
								<categoryAxisFormat labelRotation="45.0">
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</categoryAxisFormat>
								<valueAxisLabelExpression><![CDATA["Volume"]]></valueAxisLabelExpression>
								<valueAxisFormat>
									<axisFormat>
										<labelFont/>
										<tickLabelFont/>
									</axisFormat>
								</valueAxisFormat>
							</barPlot>
						</barChart>
					</axis>
				</multiAxisPlot>
			</multiAxisChart>
			<textField evaluationTime="Report">
				<reportElement x="1" y="453" width="815" height="18"/>
				<textElement textAlignment="Center" verticalAlignment="Top"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Chart limited to 50 lots max."]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band height="10">
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="20">
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
			<textField>
				<reportElement x="349" y="0" width="101" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bin Volume"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="450" y="0" width="86" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bin Yield"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="100" y="0" width="69" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle">
					<font size="10" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Volume"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="169" y="0" width="32" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bin No"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="201" y="0" width="145" height="20" backcolor="#CCCCCC"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Bin Name"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="16" y="0" width="84" height="20" backcolor="#CCCCCC"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="10" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Lot"]]></textFieldExpression>
			</textField>
		</band>
	</columnHeader>
	<detail>
		<band height="15" splitType="Prevent">
			<printWhenExpression><![CDATA[new Boolean($F{bin_parts}.intValue() != 0)]]></printWhenExpression>
			<textField isBlankWhenNull="true">
				<reportElement isPrintRepeatedValues="false" x="16" y="0" width="84" height="14" isRemoveLineWhenBlank="true" isPrintInFirstWholeBand="true"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="9" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{lot_id}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement isPrintRepeatedValues="false" x="349" y="0" width="100" height="14" isRemoveLineWhenBlank="true"/>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{bin_parts}.toString()]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement isPrintRepeatedValues="false" x="450" y="0" width="86" height="14" isRemoveLineWhenBlank="true"/>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{yield}.setScale(2,BigDecimal.ROUND_DOWN).toString()+" %"]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement isPrintRepeatedValues="false" x="169" y="0" width="32" height="14" isRemoveLineWhenBlank="true"/>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{bin_no}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="false">
				<reportElement isPrintRepeatedValues="false" x="100" y="0" width="69" height="14"/>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{parts}.toString()]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Group" evaluationGroup="XAxis">
				<reportElement isPrintRepeatedValues="false" x="1" y="0" width="15" height="14" isPrintInFirstWholeBand="true"/>
				<textElement/>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$V{lot_count}]]></textFieldExpression>
			</textField>
			<textField isBlankWhenNull="true">
				<reportElement isPrintRepeatedValues="false" x="201" y="0" width="145" height="14" isRemoveLineWhenBlank="true"/>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{bin_name}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band>
			<printWhenExpression><![CDATA[new Boolean($P{PSHOWTABLES_IC}.booleanValue())]]></printWhenExpression>
		</band>
	</columnFooter>
	<pageFooter>
		<band height="19">
			<textField>
				<reportElement x="100" y="0" width="246" height="19"/>
				<textElement verticalAlignment="Middle"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Version "+$P{PVERSION}]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="1" y="0" width="99" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.util.Date"><![CDATA[new Date()]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="536" y="0" width="241" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA["Page " + $V{PAGE_NUMBER} + " of "]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" pattern="" isBlankWhenNull="false">
				<reportElement key="textField" x="777" y="0" width="39" height="19" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="10"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<image vAlign="Middle" onErrorType="Icon">
				<reportElement x="388" y="0" width="53" height="19"/>
				<imageExpression class="java.lang.String"><![CDATA["repo:/Resources/galaxyb.GIF"]]></imageExpression>
			</image>
		</band>
	</pageFooter>
	<summary>
		<band height="89">
			<textField>
				<reportElement x="1" y="0" width="815" height="89"/>
				<textElement verticalAlignment="Middle" markup="html"/>
				<textFieldExpression class="java.lang.String"><![CDATA["Notes :<br> - Total parts measures have been computed using consolidated data. <br> - The Yield measure is computed from the total number of parts with the specified binning(s) and the total gross die.<br>"]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
